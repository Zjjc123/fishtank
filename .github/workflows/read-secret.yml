name: Read App Store Connect Secrets

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/read-secret.yml'

jobs:
  read-secrets:
    runs-on: ubuntu-latest
    outputs:
      asc_issuer_id: ${{ steps.read_secrets.outputs.asc_issuer_id }}
      asc_issuer_id_txt: ${{ steps.read_secrets.outputs.asc_issuer_id_txt }}
      asc_key_id: ${{ steps.read_secrets.outputs.asc_key_id }}
      asc_key_id_txt: ${{ steps.read_secrets.outputs.asc_key_id_txt }}
      asc_key_p8: ${{ steps.read_secrets.outputs.asc_key_p8 }}
      asc_key_p8_txt: ${{ steps.read_secrets.outputs.asc_key_p8_txt }}
      fastlane_password: ${{ steps.read_secrets.outputs.fastlane_password }}
      fastlane_password_txt: ${{ steps.read_secrets.outputs.fastlane_password_txt }}
      gh_token: ${{ steps.read_secrets.outputs.gh_token }}
      gh_token_txt: ${{ steps.read_secrets.outputs.gh_token_txt }}
      match_password: ${{ steps.read_secrets.outputs.match_password }}
      match_password_txt: ${{ steps.read_secrets.outputs.match_password_txt }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Read all secrets
      id: read_secrets
      run: |
        # Read ASC_ISSUER_ID secret
        echo "asc_issuer_id=${{ secrets.ASC_ISSUER_ID }}" >> $GITHUB_OUTPUT
        echo "asc_issuer_id_txt=${{ secrets.ASC_ISSUER_ID }}" >> $GITHUB_OUTPUT
        
        # Read ASC_KEY_ID secret
        echo "asc_key_id=${{ secrets.ASC_KEY_ID }}" >> $GITHUB_OUTPUT
        echo "asc_key_id_txt=${{ secrets.ASC_KEY_ID }}" >> $GITHUB_OUTPUT
        
        # Read ASC_KEY_P8 secret
        echo "asc_key_p8=${{ secrets.ASC_KEY_P8 }}" >> $GITHUB_OUTPUT
        echo "asc_key_p8_txt=${{ secrets.ASC_KEY_P8 }}" >> $GITHUB_OUTPUT
        
        # Read FASTLANE_PASSWORD secret
        echo "fastlane_password=${{ secrets.FASTLANE_PASSWORD }}" >> $GITHUB_OUTPUT
        echo "fastlane_password_txt=${{ secrets.FASTLANE_PASSWORD }}" >> $GITHUB_OUTPUT
        
        # Read GH_TOKEN secret
        echo "gh_token=${{ secrets.GH_TOKEN }}" >> $GITHUB_OUTPUT
        echo "gh_token_txt=${{ secrets.GH_TOKEN }}" >> $GITHUB_OUTPUT
        
        # Read MATCH_PASSWORD secret
        echo "match_password=${{ secrets.MATCH_PASSWORD }}" >> $GITHUB_OUTPUT
        echo "match_password_txt=${{ secrets.MATCH_PASSWORD }}" >> $GITHUB_OUTPUT
        
        # Print values for debugging (will be masked in logs)
        echo "ASC_ISSUER_ID value: ${{ secrets.ASC_ISSUER_ID }}"
        echo "ASC_KEY_ID value: ${{ secrets.ASC_KEY_ID }}"
        echo "ASC_KEY_P8 value: ${{ secrets.ASC_KEY_P8 }}"
        echo "FASTLANE_PASSWORD value: ${{ secrets.FASTLANE_PASSWORD }}"
        echo "GH_TOKEN value: ${{ secrets.GH_TOKEN }}"
        echo "MATCH_PASSWORD value: ${{ secrets.MATCH_PASSWORD }}"
        
    - name: Display all outputs
      run: |
        echo "ASC_ISSUER_ID output: ${{ steps.read_secrets.outputs.asc_issuer_id }}"
        echo "ASC_ISSUER_ID_TXT output: ${{ steps.read_secrets.outputs.asc_issuer_id_txt }}"
        echo "ASC_KEY_ID output: ${{ steps.read_secrets.outputs.asc_key_id }}"
        echo "ASC_KEY_ID_TXT output: ${{ steps.read_secrets.outputs.asc_key_id_txt }}"
        echo "ASC_KEY_P8 output: ${{ steps.read_secrets.outputs.asc_key_p8 }}"
        echo "ASC_KEY_P8_TXT output: ${{ steps.read_secrets.outputs.asc_key_p8_txt }}"
        echo "FASTLANE_PASSWORD output: ${{ steps.read_secrets.outputs.fastlane_password }}"
        echo "FASTLANE_PASSWORD_TXT output: ${{ steps.read_secrets.outputs.fastlane_password_txt }}"
        echo "GH_TOKEN output: ${{ steps.read_secrets.outputs.gh_token }}"
        echo "GH_TOKEN_TXT output: ${{ steps.read_secrets.outputs.gh_token_txt }}"
        echo "MATCH_PASSWORD output: ${{ steps.read_secrets.outputs.match_password }}"
        echo "MATCH_PASSWORD_TXT output: ${{ steps.read_secrets.outputs.match_password_txt }}"
        
    - name: Create secret artifacts
      run: |
        # Create directory for artifacts
        mkdir -p secrets
        
        # Create individual files for each secret
        echo "${{ steps.read_secrets.outputs.asc_issuer_id }}" > secrets/asc_issuer_id.txt
        echo "${{ steps.read_secrets.outputs.asc_issuer_id_txt }}" > secrets/asc_issuer_id_txt.txt
        
        echo "${{ steps.read_secrets.outputs.asc_key_id }}" > secrets/asc_key_id.txt
        echo "${{ steps.read_secrets.outputs.asc_key_id_txt }}" > secrets/asc_key_id_txt.txt
        
        echo "${{ steps.read_secrets.outputs.asc_key_p8 }}" > secrets/asc_key_p8.txt
        echo "${{ steps.read_secrets.outputs.asc_key_p8_txt }}" > secrets/asc_key_p8_txt.txt
        
        echo "${{ steps.read_secrets.outputs.fastlane_password }}" > secrets/fastlane_password.txt
        echo "${{ steps.read_secrets.outputs.fastlane_password_txt }}" > secrets/fastlane_password_txt.txt
        
        echo "${{ steps.read_secrets.outputs.gh_token }}" > secrets/gh_token.txt
        echo "${{ steps.read_secrets.outputs.gh_token_txt }}" > secrets/gh_token_txt.txt
        
        echo "${{ steps.read_secrets.outputs.match_password }}" > secrets/match_password.txt
        echo "${{ steps.read_secrets.outputs.match_password_txt }}" > secrets/match_password_txt.txt
        
        # List the created files
        ls -la secrets/
        
    - name: Upload ASC_ISSUER_ID artifact
      uses: actions/upload-artifact@v4
      with:
        name: asc_issuer_id
        path: secrets/asc_issuer_id.txt
        
    - name: Upload ASC_ISSUER_ID_TXT artifact
      uses: actions/upload-artifact@v4
      with:
        name: asc_issuer_id_txt
        path: secrets/asc_issuer_id_txt.txt
        
    - name: Upload ASC_KEY_ID artifact
      uses: actions/upload-artifact@v4
      with:
        name: asc_key_id
        path: secrets/asc_key_id.txt
        
    - name: Upload ASC_KEY_ID_TXT artifact
      uses: actions/upload-artifact@v4
      with:
        name: asc_key_id_txt
        path: secrets/asc_key_id_txt.txt
        
    - name: Upload ASC_KEY_P8 artifact
      uses: actions/upload-artifact@v4
      with:
        name: asc_key_p8
        path: secrets/asc_key_p8.txt
        
    - name: Upload ASC_KEY_P8_TXT artifact
      uses: actions/upload-artifact@v4
      with:
        name: asc_key_p8_txt
        path: secrets/asc_key_p8_txt.txt
        
    - name: Upload FASTLANE_PASSWORD artifact
      uses: actions/upload-artifact@v4
      with:
        name: fastlane_password
        path: secrets/fastlane_password.txt
        
    - name: Upload FASTLANE_PASSWORD_TXT artifact
      uses: actions/upload-artifact@v4
      with:
        name: fastlane_password_txt
        path: secrets/fastlane_password_txt.txt
        
    - name: Upload GH_TOKEN artifact
      uses: actions/upload-artifact@v4
      with:
        name: gh_token
        path: secrets/gh_token.txt
        
    - name: Upload GH_TOKEN_TXT artifact
      uses: actions/upload-artifact@v4
      with:
        name: gh_token_txt
        path: secrets/gh_token_txt.txt
        
    - name: Upload MATCH_PASSWORD artifact
      uses: actions/upload-artifact@v4
      with:
        name: match_password
        path: secrets/match_password.txt
        
    - name: Upload MATCH_PASSWORD_TXT artifact
      uses: actions/upload-artifact@v4
      with:
        name: match_password_txt
        path: secrets/match_password_txt.txt 